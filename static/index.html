<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asymptote - Semantic PDF Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .highlight {
            background-color: #fef08a;
            font-weight: 600;
            padding: 0 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold mb-2">üìö Asymptote</h1>
             <!-- <img src="./static/logo.svg" class="mb-2" width="200" alt=""> -->
            <p class="text-blue-100 text-lg">Semantic PDF Search</p>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="totalChunks">-</div>
                <div class="text-gray-600 text-sm mt-1">Indexed Chunks</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="totalDocs">-</div>
                <div class="text-gray-600 text-sm mt-1">Documents</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="storageType">-</div>
                <div class="text-gray-600 text-sm mt-1">Storage</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
            <div class="flex border-b">
                <button onclick="switchTab('search')" class="tab-button flex-1 px-6 py-4 text-center font-medium transition-colors hover:bg-blue-50 active" data-tab="search">
                    üîç Search
                </button>
                <button onclick="switchTab('upload')" class="tab-button flex-1 px-6 py-4 text-center font-medium transition-colors hover:bg-blue-50" data-tab="upload">
                    üì§ Upload
                </button>
                <button onclick="switchTab('documents')" class="tab-button flex-1 px-6 py-4 text-center font-medium transition-colors hover:bg-blue-50" data-tab="documents">
                    üìÅ Documents
                </button>
                <button onclick="switchTab('settings')" class="tab-button flex-1 px-6 py-4 text-center font-medium transition-colors hover:bg-blue-50" data-tab="settings">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content active">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex gap-3 mb-6">
                    <input
                        type="text"
                        id="searchQuery"
                        placeholder="Ask a question or search for concepts..."
                        class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                        onkeypress="if(event.key==='Enter') search()"
                    >
                    <input
                        type="number"
                        id="topK"
                        value="10"
                        min="1"
                        max="50"
                        title="Number of results"
                        class="w-20 px-3 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                    >
                    <button onclick="search()" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors">
                        Search
                    </button>
                </div>
                <div id="searchResults"></div>
            </div>
        </div>

        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <div
                    id="uploadArea"
                    onclick="document.getElementById('fileInput').click()"
                    class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors"
                >
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">üìé Drop PDF files here or click to browse</h3>
                    <p class="text-gray-500">Upload one or more PDF documents to index</p>
                    <input
                        type="file"
                        id="fileInput"
                        multiple
                        accept=".pdf"
                        class="hidden"
                        onchange="handleFiles(this.files)"
                    >
                </div>
                <div id="fileList" class="mt-4"></div>
                <div id="uploadStatus" class="mt-4"></div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div id="documents-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <button onclick="loadDocuments()" class="mb-4 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors">
                    üîÑ Refresh
                </button>
                <div id="documentsList"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">Current Configuration</h3>
                <div id="settingsDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let currentSearchQuery = '';
        const API_BASE = window.location.origin;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            setupDragDrop();
            setupTabStyles();
        });

        // Setup tab button styles
        function setupTabStyles() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(b => {
                        b.classList.remove('active', 'bg-blue-600', 'text-white');
                        b.classList.add('text-gray-700');
                    });
                    this.classList.remove('text-gray-700');
                    this.classList.add('active', 'bg-blue-600', 'text-white');
                });
            });
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'documents') {
                loadDocuments();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const healthRes = await fetch(`${API_BASE}/health`);
                const health = await healthRes.json();
                document.getElementById('totalChunks').textContent = health.indexed_chunks.toLocaleString();

                const docsRes = await fetch(`${API_BASE}/documents`);
                const docs = await docsRes.json();
                document.getElementById('totalDocs').textContent = docs.total_documents;

                document.getElementById('storageType').textContent = 'JSON';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Highlight keywords in text
        function highlightText(text, query) {
            if (!query || !text) return text;

            const keywords = query.toLowerCase().split(/\s+/).filter(k => k.length > 2);
            let result = text;

            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                result = result.replace(regex, '<span class="highlight">$1</span>');
            });

            return result;
        }

        // Search
        async function search() {
            const query = document.getElementById('searchQuery').value.trim();
            const topK = parseInt(document.getElementById('topK').value);
            const resultsDiv = document.getElementById('searchResults');

            if (!query) {
                resultsDiv.innerHTML = '<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded"><p class="text-red-800">Please enter a search query</p></div>';
                return;
            }

            currentSearchQuery = query;

            resultsDiv.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                    <p class="text-gray-600 mt-4">Searching...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, top_k: topK })
                });

                const data = await response.json();

                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded"><p class="text-yellow-800">No results found. Try a different query or upload more documents.</p></div>';
                    return;
                }

                resultsDiv.innerHTML = data.results.map((result, idx) => `
                    <div class="bg-gray-50 border-l-4 border-blue-500 p-6 rounded-lg mb-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div class="font-semibold text-lg text-gray-800">${idx + 1}. ${result.filename}</div>
                            <div class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                                ${(result.similarity_score * 100).toFixed(1)}%
                            </div>
                        </div>
                        <div class="text-gray-600 text-sm mb-3">Page ${result.page_number} ‚Ä¢ Document ID: ${result.document_id}</div>
                        <div class="text-gray-800 leading-relaxed mb-4">${highlightText(result.text_snippet, query)}</div>
                        <div class="flex gap-3">
                            <a href="${result.page_url}" target="_blank"
                               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors text-sm font-medium">
                                üìÑ Open at Page ${result.page_number}
                            </a>
                            <a href="${result.pdf_url}" target="_blank"
                               class="inline-flex items-center px-4 py-2 border-2 border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors text-sm font-medium">
                                ‚¨áÔ∏è Download PDF
                            </a>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                resultsDiv.innerHTML = `<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded"><p class="text-red-800">Error: ${error.message}</p></div>`;
            }
        }

        // File upload
        function setupDragDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-500', 'bg-blue-50');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                handleFiles(e.dataTransfer.files);
            });
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));

            const fileList = document.getElementById('fileList');
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded"><p class="text-red-800">No PDF files selected</p></div>';
                return;
            }

            fileList.innerHTML = `
                <div class="space-y-2">
                    ${selectedFiles.map(f => `
                        <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center">
                            <span class="text-gray-800">üìÑ ${f.name}</span>
                            <span class="text-gray-600 text-sm">${(f.size / 1024 / 1024).toFixed(2)} MB</span>
                        </div>
                    `).join('')}
                </div>
                <button onclick="uploadFiles()" class="mt-4 px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors">
                    Upload ${selectedFiles.length} file(s)
                </button>
            `;
        }

        async function uploadFiles() {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                    <p class="text-gray-600 mt-4">Uploading and indexing...</p>
                </div>
            `;

            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('files', file));

            try {
                const response = await fetch(`${API_BASE}/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                statusDiv.innerHTML = `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <p class="text-green-800 font-semibold">‚úì Success!</p>
                        <p class="text-green-700 mt-1">${data.message}</p>
                        <p class="text-green-700">Processed ${data.total_pages} pages into ${data.total_chunks} chunks</p>
                    </div>
                `;

                document.getElementById('fileList').innerHTML = '';
                selectedFiles = [];
                loadStats();

            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded"><p class="text-red-800">Error: ${error.message}</p></div>`;
            }
        }

        // Documents list
        async function loadDocuments() {
            const listDiv = document.getElementById('documentsList');
            listDiv.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                    <p class="text-gray-600 mt-4">Loading...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/documents`);
                const data = await response.json();

                if (data.documents.length === 0) {
                    listDiv.innerHTML = '<p class="text-gray-600 text-center py-8">No documents indexed yet. Upload some PDFs to get started!</p>';
                    return;
                }

                listDiv.innerHTML = `
                    <div class="space-y-3">
                        ${data.documents.map(doc => `
                            <div class="bg-gray-50 p-5 rounded-lg flex justify-between items-center hover:shadow-md transition-shadow">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800 mb-1">üìÑ ${doc.filename}</div>
                                    <div class="text-gray-600 text-sm">
                                        ${doc.num_pages} pages ‚Ä¢ ${doc.num_chunks} chunks ‚Ä¢ ID: ${doc.document_id}
                                    </div>
                                </div>
                                <button onclick="deleteDocument('${doc.document_id}', '${doc.filename}')"
                                        class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 active:bg-red-800 transition-colors">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                listDiv.innerHTML = `<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded"><p class="text-red-800">Error: ${error.message}</p></div>`;
            }
        }

        async function deleteDocument(docId, filename) {
            if (!confirm(`Delete "${filename}"?`)) return;

            try {
                await fetch(`${API_BASE}/documents/${docId}`, { method: 'DELETE' });
                loadDocuments();
                loadStats();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Settings display
        async function loadSettings() {
            const settingsDiv = document.getElementById('settingsDisplay');

            settingsDiv.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">Embedding Model</label>
                        <p class="text-gray-600 text-sm">all-MiniLM-L6-v2 (384 dimensions)</p>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">Chunk Size</label>
                        <p class="text-gray-600 text-sm">600 characters</p>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">Chunk Overlap</label>
                        <p class="text-gray-600 text-sm">100 characters</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">Default Results</label>
                        <p class="text-gray-600 text-sm">10 per search</p>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">Metadata Storage</label>
                        <p class="text-gray-600 text-sm">JSON (configurable to SQLite)</p>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">API Documentation</label>
                        <p class="text-gray-600 text-sm"><a href="/docs" target="_blank" class="text-blue-600 hover:text-blue-800 underline">OpenAPI Docs</a></p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
